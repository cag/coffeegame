<!DOCTYPE html>

<html>
<head>
  <title>demo2.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="cg.html">
                  cg.coffee
                </a>
              
                
                <a class="source" href="audio.html">
                  audio.coffee
                </a>
              
                
                <a class="source" href="entity.html">
                  entity.coffee
                </a>
              
                
                <a class="source" href="game.html">
                  game.coffee
                </a>
              
                
                <a class="source" href="geometry.html">
                  geometry.coffee
                </a>
              
                
                <a class="source" href="input.html">
                  input.coffee
                </a>
              
                
                <a class="source" href="loader.html">
                  loader.coffee
                </a>
              
                
                <a class="source" href="map.html">
                  map.coffee
                </a>
              
                
                <a class="source" href="physics.html">
                  physics.coffee
                </a>
              
                
                <a class="source" href="sprite.html">
                  sprite.coffee
                </a>
              
                
                <a class="source" href="util.html">
                  util.coffee
                </a>
              
                
                <a class="source" href="demo.html">
                  demo.coffee
                </a>
              
                
                <a class="source" href="demo2.html">
                  demo2.coffee
                </a>
              
                
                <a class="source" href="main.html">
                  main.coffee
                </a>
              
                
                <a class="source" href="ui.html">
                  ui.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>demo2.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="hljs-string">'./cg'</span>, <span class="hljs-string">'./ui'</span>],
  <span class="hljs-function"><span class="hljs-params">(cg, ui)</span> -&gt;</span>
    {input, audio, util, game, geometry, entity, physics} = cg

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Character</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">entity</span>.<span class="hljs-title">Entity</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(x, y, shape, <span class="hljs-property">@sprite</span>)</span> -&gt;</span>
            <span class="hljs-keyword">super</span> x, y, shape
            <span class="hljs-property">@sprite</span>.startAnimation <span class="hljs-string">'look down'</span>

        <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(context, offx, offy)</span> -&gt;</span>
            <span class="hljs-property">@sprite</span>.draw context, <span class="hljs-property">@x</span> + offx, <span class="hljs-property">@y</span> + offy, <span class="hljs-property">@facing_left</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>ui.drawTextBox 0, 0, 190, 44,
    spacing: 10.0
    lines: [‘T̬͓͂̋ͧ̊͗̚o̻̰͈̼̥ͥͤ͗̊͑ͨ̈́ ͏̻̩̬̭͕̠ī͉̖̠̲̲̘͠ṋ̬̼͔͇̞͔̾͑ͭͪͯ͆v̺̫̘̩̊̓ó̼̥̖̩̖̗̣k͓͔̠̉e͙̱͍̯̽ͫ̇͠ ͚̦͉̮ͩ͆ͬ̈́ͫͭ̚t̡̺͚͙̅̈́ͪ̉h̨͔̳̬̼̲̖è͈̙̲̜̲̜ͯ̃ ̘̜̮̞ͨ̃̃̏ͦh̬̤͖̅̄ͤ̄ͨ̚íͪv̞̹̬̝̀͛ͩ͂́e̛̙̟͎̞͔̦͑-ͣ̅̌̃͂m̪̮͉̗͚ͤͨͥ͛i̘̥̜͠n̖̰̬̺̑̿̚d̶̰̳̍ͅ ̄ͦ҉̺̪̠͈r̶͔̐̏ͩ̈́ͯ͐̋ě̝̯̼̘̦͘ͅp͔̅̚ŕ̢͙͉͍̤̳̞̩̒ͯe̻̠͔̹̝͈s͙̖̰̝͇͔̮̿ͩͧe̠͙͕͉̠̱̾̑̑̈́̑ͅṅ̪͈̙ͯ̔̓̒̓t̵͍̜͇̪̀ͧͪͤ̎ͬi̲̤̣͍̪̐̄n̩͍̉ͭ̊̽̊ͧͣ͜ǧ̯̠̲̌͒̕ͅ ̦͔̾ͮͦͥ͌č̡̖͎͆ḩ̖ͥͬ̌ͥͦa̴̺͙͇̫͍ͫ͛o͔̯͈͕͎̼̾ͣ͗͊̎s̰ͧ̓͒͟.̢͕͙̲̫͓ͯͨ̾͐’
    ‘̦̔I͍̠̘̩̳̙͊̿̿ͨͭ̊̚͟nv̨̘̜̪̞̲ͨ̾o̝͙̣͚͙͔͟k͐̊͒͛ͯ́ȋ̧͉̥͚̙̮ͭṅg̲̻͉͙͆̌̎ͥ̊ͬͧ ̆̈́́t̢̻̮̘̘̠̻͕ͯh̝̯̞̝͈ͥ̔̌̂͛͜e̫̭͚̼̪̫̪̊̚ ͈̣͇̪̳̪̜ͦͪf̪̼̫̘̲̟̮̿́ė̬̤̯̘̣͌eͣ͊͆̅̐̚͏̟͚̞̟͇̙̦l͍̹͕̆̀i̯͈͍͗̒͌ͮ̀͋̋͟n̥̞̎ͥg̺̻͇̳̪̺͎͗ͮ̓̇̃ ̶͈͕̭̫ͯͦͮ̋ͪ͂ͧő͍̞ͅf͉̗̩̙͕̹̩ͩͭͥ ̡͈̰̹̖͍̯̾̿ͩ̚c̢̞͖̳ĥ̴͗ào͙̲͇̮̭͡s͕̰͚̼̼̥̖̆̽̉́̐͊.̟̘̲̣̪͙̈́̅ͅ’
    ‘̥̻̩̫ͬ͝W̥͎̻̘̉̓ͪ̍ͯĭ̝̙̫͓̽̎t̨͕̗̙̝̠h̤̬̟̟ͣ͒͌̋̓̽ͯͅ ͏o͚ṵ̙̗̯ͬ͌͂̾͆ͬͅt͚͉͉̲̮̅̍̕ ͇̝̜͚̙̣̈́͒ͧō̺̫̙̘͂̑̔̈ͅr̮̙̠̼̪̒͘d̮͉̲̳̟̆̋̋̈́̊e͏͇̘̩͉̤͓ͅŕ̩̜.̨͙̬̹̮ͯͨ̃’
    ‘̡͚̬͙͒͛̃͗͗̿ͅT̰͎̥h̺͉̹̯̻͖̒ͧ̆̿ͣe̓͌̅̇̃̊͏ ̢̼̟̦͈̼ͣN̰̼̙̙͋̉̎́e̫̟̘̪̞̒͂̾̈́ͦ͌z̢̠̑̒̓͗̽ͮp̷̪ͨe̶̎̔̂͐̀̀r̗͋͑d̖̟̯̥i̗͎̙̰̜͐͂a̠̖̙̻̦n͋̓ͪͦ̒̊̀ ͍̮̞̋̀h̎ͮ͒͋͌ͪ̀îͥ́̊ͩ̐ͣ́v̹͙͇̬̋̇͂ͅe̟̜̝̜͇͓̎̈́̓̄̕-̲͖̝̇ͭͯͮ͞m̮̩̭̯͉̂ͬͯị̶͈̋̅̍ň̤̣̮͔̻̠̕d͍̩̞͙̓̏ͮͭ ̋o̘͖̽ͪ̈́̒̃̈́f͕̺̘̜̼̼̪̃͊̕ ̏̐̀c̸͍̹̗̤ͥͩ̓ͬ̓̎̚ḩ̝̊̊ͤā̻̺̪̹̀o̺̞̫͓̊ͪͩ̔̕s̭͍̞̰͆̓ͦͯͣͮ̚͜.ͥͯ͛͞ ̜̯͕͚̓ͦ̇ͪ͛Z̠̘̭̣͉̩͛̎̒̃̾ͩͅa̘̹͈̬͛l̦̭̖̠̲͕̏̓̀̽̐̊̚ǵ̸̜͇͓̻͔̰̝̾o̯ͨ̒͒ͣ̿̐͝.̩̺̩̙̙̿ͯͫ͛͊͢’
    ‘̴͖̰͍͈̹̹̥̎H̘̿̈e̠̬ͮ ̯̌̽͑̒ͯ̎ẅ͉͇̹̞͉̹̋ͤ̄͆͆̂̕ͅh͔̫̮̱̥̓́ͣ͆͛ͅo̳̞̼̘͉̔̽̌̀̚ ̐ͫ̿̃W̲͉͞å̡͙̗̄i̦̰ͦͦt̥͋̏̏ͅs͙̮͉͎͚̮͐ͦ͆ ̵̩̞̖̩̝͖͓̑̆B̝̗̙̗͕̹͋͗ͨͮ́ĕ͕͓̞̤͜h͚̮̿̔ͬ̍i͚͇̪͉̓ͯn̢̤̜͚͕̫̪̓d̡͖͖̜̫̬͇̦̽ ͎̤̭̩̻͖̽͜T͔̲̤͖̮̟̮͗̑̒̄̈́h̼͉̲̫̘ě͆̀ ̨͍͇̹͇̻ͪͪ̈́ͣͭ͑W̌̄͗̓̂̒̾͜a͊l̸̜̩̺̫͓̞̠ͪͧl̨̝͇̰͇͒.̛̜͕̼̫̮̠̿͆ͬͅ’
    ‘͙͎̙̩̺̪̑ͫ̎͋͋Z̛̺̻̱̍̌ͪ̓ͅA̦̻͓̹̍ͤͨ̓ͩ̈L̡̅͐ͫĜ͔͕̮ͯ̃͊̀͐O̯ͤ͂̄̒̉͟!͓̲̽ͫ͢’].map((line, index, lines)-&gt;
            return ui.wordWrapText line, 160-6
        ).reduce (a, b) -&gt; a.concat b</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayerCharacter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Character</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(x, y, shape, sprite)</span> -&gt;</span>
            <span class="hljs-keyword">super</span> x, y, shape, sprite
            <span class="hljs-property">@state</span> = <span class="hljs-string">'look down'</span>
            <span class="hljs-property">@dir</span> = <span class="hljs-string">'down'</span>
            map = game.currentScene().map
            player = <span class="hljs-keyword">this</span>
            ent_layer = map.getLayerByName <span class="hljs-string">'Entities'</span>

            <span class="hljs-property">@activation_point_check</span> = <span class="hljs-keyword">new</span> entity.Entity x, y + <span class="hljs-number">2</span> * <span class="hljs-property">@shape</span>.bounds_offsets[<span class="hljs-number">3</span>], <span class="hljs-keyword">new</span> geometry.Point
            <span class="hljs-property">@activation_point_check</span>.collides = util.constructBitmask [<span class="hljs-number">0</span>]
            <span class="hljs-property">@activation_point_check</span>.onCollide = <span class="hljs-function"><span class="hljs-params">(ent, info)</span> -&gt;</span>
                <span class="hljs-keyword">if</span> input.jump.pressed
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ent.onActivate?
                        ent.onActivate = map.tryGettingCallbackForName ent.properties?.onActivate
                    ent.onActivate ent
                <span class="hljs-keyword">return</span>
            ent_layer.addEntity <span class="hljs-property">@activation_point_check</span>
            
            map.camera.post_update = <span class="hljs-function"><span class="hljs-params">(dt)</span> -&gt;</span>
                <span class="hljs-property">@x</span> = player.x
                <span class="hljs-property">@y</span> = player.y
                <span class="hljs-keyword">return</span>

        <span class="hljs-attribute">update</span>: <span class="hljs-function"><span class="hljs-params">(dt)</span> -&gt;</span>
            sprite = <span class="hljs-property">@sprite</span>
            state = <span class="hljs-property">@state</span>
<span class="hljs-function">            <span class="hljs-title">switchStateTo</span> = <span class="hljs-params">(name)</span> -&gt;</span>
                <span class="hljs-keyword">if</span> state <span class="hljs-keyword">isnt</span> name
                    sprite.startAnimation name
                    state = name
                <span class="hljs-keyword">return</span>

            vxc = <span class="hljs-number">0.0</span>
            vyc = <span class="hljs-number">0.0</span>

            <span class="hljs-keyword">if</span> input.left.state <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> input.right.state
                <span class="hljs-property">@facing_left</span> = <span class="hljs-literal">true</span>
                vxc = -<span class="hljs-number">1.0</span>
                <span class="hljs-property">@dir</span> = <span class="hljs-string">'right'</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> input.right.state <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> input.left.state
                <span class="hljs-property">@facing_left</span> = <span class="hljs-literal">false</span>
                vxc = <span class="hljs-number">1.0</span>
                <span class="hljs-property">@dir</span> = <span class="hljs-string">'right'</span>

            <span class="hljs-keyword">if</span> input.up.state <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> input.down.state
                vyc = -<span class="hljs-number">1.0</span>
                <span class="hljs-property">@dir</span> = <span class="hljs-string">'up'</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> input.down.state <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> input.up.state
                vyc = <span class="hljs-number">1.0</span>
                <span class="hljs-property">@dir</span> = <span class="hljs-string">'down'</span>

            <span class="hljs-keyword">if</span> vyc == <span class="hljs-number">0.0</span>
                <span class="hljs-keyword">if</span> vxc == <span class="hljs-number">0.0</span>
                    switchStateTo <span class="hljs-string">'look '</span> + <span class="hljs-property">@dir</span>
                <span class="hljs-keyword">else</span>
                    switchStateTo <span class="hljs-string">'go right'</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> vyc &lt; <span class="hljs-number">0.0</span>
                switchStateTo <span class="hljs-string">'go up'</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> vyc &gt; <span class="hljs-number">0.0</span>
                switchStateTo <span class="hljs-string">'go down'</span>

            <span class="hljs-property">@state</span> = state
            <span class="hljs-property">@velocity</span> = [<span class="hljs-number">64.0</span> * vxc, <span class="hljs-number">64.0</span> * vyc]
            physics.integrate <span class="hljs-keyword">this</span>, dt
            sprite.update dt</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO: make this better</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-property">@dir</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'right'</span>
                <span class="hljs-keyword">if</span> <span class="hljs-property">@facing_left</span>
                    <span class="hljs-property">@activation_point_check</span>.x = <span class="hljs-property">@x</span> + <span class="hljs-number">2</span> * <span class="hljs-property">@shape</span>.bounds_offsets[<span class="hljs-number">0</span>]
                    <span class="hljs-property">@activation_point_check</span>.y = <span class="hljs-property">@y</span>
                <span class="hljs-keyword">else</span>
                    <span class="hljs-property">@activation_point_check</span>.x = <span class="hljs-property">@x</span> + <span class="hljs-number">2</span> * <span class="hljs-property">@shape</span>.bounds_offsets[<span class="hljs-number">1</span>]
                    <span class="hljs-property">@activation_point_check</span>.y = <span class="hljs-property">@y</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@dir</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'up'</span>
                <span class="hljs-property">@activation_point_check</span>.x = <span class="hljs-property">@x</span>
                <span class="hljs-property">@activation_point_check</span>.y = <span class="hljs-property">@y</span> + <span class="hljs-number">2</span> * <span class="hljs-property">@shape</span>.bounds_offsets[<span class="hljs-number">2</span>]
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@dir</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'down'</span>
                <span class="hljs-property">@activation_point_check</span>.x = <span class="hljs-property">@x</span>
                <span class="hljs-property">@activation_point_check</span>.y = <span class="hljs-property">@y</span> + <span class="hljs-number">2</span> * <span class="hljs-property">@shape</span>.bounds_offsets[<span class="hljs-number">3</span>]
            <span class="hljs-keyword">return</span>

    player = <span class="hljs-literal">null</span>
    player_shape = <span class="hljs-literal">null</span>
    player_sprite = <span class="hljs-literal">null</span>

    <span class="hljs-attribute">setPlayerMetadata</span>: <span class="hljs-function"><span class="hljs-params">(shape, sprite)</span> -&gt;</span>
        player_shape = shape
        player_sprite = sprite
        <span class="hljs-keyword">return</span>

    <span class="hljs-attribute">handlePlayerStart</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
        player = <span class="hljs-keyword">new</span> PlayerCharacter obj.x, obj.y, player_shape, player_sprite, obj.map.camera
        player.obstructs = util.constructBitmask [<span class="hljs-number">0</span>]
        obj.layer.addEntity player
        <span class="hljs-keyword">return</span>

    <span class="hljs-attribute">handleChest1Start</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
        <span class="hljs-keyword">return</span>

    <span class="hljs-attribute">tryOpeningChest1</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
        tx = (obj.x / obj.map.tilewidth) | <span class="hljs-number">0</span>
        ty = (obj.y / obj.map.tileheight) | <span class="hljs-number">0</span>
        layer = obj.map.getLayerByName(<span class="hljs-string">'Ground'</span>)
        td = layer.data[tx][ty][..]
        td[<span class="hljs-number">0</span>]++
        layer.setTile tx, ty, td
        <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
