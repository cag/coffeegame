<!DOCTYPE html>

<html>
<head>
  <title>map.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="cg.html">
                  cg.coffee
                </a>
              
                
                <a class="source" href="audio.html">
                  audio.coffee
                </a>
              
                
                <a class="source" href="entity.html">
                  entity.coffee
                </a>
              
                
                <a class="source" href="game.html">
                  game.coffee
                </a>
              
                
                <a class="source" href="geometry.html">
                  geometry.coffee
                </a>
              
                
                <a class="source" href="input.html">
                  input.coffee
                </a>
              
                
                <a class="source" href="loader.html">
                  loader.coffee
                </a>
              
                
                <a class="source" href="map.html">
                  map.coffee
                </a>
              
                
                <a class="source" href="physics.html">
                  physics.coffee
                </a>
              
                
                <a class="source" href="sprite.html">
                  sprite.coffee
                </a>
              
                
                <a class="source" href="util.html">
                  util.coffee
                </a>
              
                
                <a class="source" href="demo.html">
                  demo.coffee
                </a>
              
                
                <a class="source" href="main.html">
                  main.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>map.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="hljs-string">'jquery'</span>, <span class="hljs-string">'./game'</span>, <span class="hljs-string">'./entity'</span>, <span class="hljs-string">'./geometry'</span>, <span class="hljs-string">'./util'</span>],
  <span class="hljs-function"><span class="hljs-params">($, game, entity, geometry, util)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A prefix and suffix applied to names passed into map constructors
so that it loads from the right place.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    url_prefix = <span class="hljs-string">'assets/'</span>
    url_suffix = <span class="hljs-string">'.json'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If <code>layers_cached</code> is true, then tiles will be cached in blocks
of <code>layer_cache_factor</code> square and the blocks will be drawn
instead of tiles.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    layers_cached = <span class="hljs-literal">true</span>
    layer_cache_factor = <span class="hljs-number">16</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Comparison helper functions for sorting entities.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">byLeftBound</span> = <span class="hljs-params">(ent_a, ent_b)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> ent_a.x + ent_a.shape.bounds_offsets[<span class="hljs-number">0</span>] -
            ent_b.x - ent_b.shape.bounds_offsets[<span class="hljs-number">0</span>]
<span class="hljs-function">    
    <span class="hljs-title">byBottomBound</span> = <span class="hljs-params">(ent_a, ent_b)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> ent_a.y + ent_a.shape.bounds_offsets[<span class="hljs-number">3</span>] -
            ent_b.y - ent_b.shape.bounds_offsets[<span class="hljs-number">3</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This module expects maps created in <a href="http://www.mapeditor.org/">Tiled</a>
and exported using the JSON option.
Refer to the <a href="https://github.com/bjorn/tiled/wiki/TMX-Map-Format">TMX Map Format</a>
for information on how the map format works.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TileSet</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(json_data, onload)</span> -&gt;</span>
            <span class="hljs-property">@name</span> = json_data.name
            <span class="hljs-property">@first_gid</span> = json_data.firstgid
            <span class="hljs-property">@tile_width</span> = json_data.tilewidth
            <span class="hljs-property">@tile_height</span> = json_data.tileheight
            <span class="hljs-property">@margin</span> = json_data.margin
            <span class="hljs-property">@spacing</span> = json_data.spacing
            <span class="hljs-property">@properties</span> = json_data.properties
            
            tileset = <span class="hljs-keyword">this</span>
            <span class="hljs-property">@image</span> = <span class="hljs-keyword">new</span> Image()
            <span class="hljs-property">@image</span>.onload = <span class="hljs-function">-&gt;</span>
                iw = <span class="hljs-property">@naturalWidth</span>
                ih = <span class="hljs-property">@naturalHeight</span>
                <span class="hljs-keyword">if</span> iw <span class="hljs-keyword">isnt</span> json_data.imagewidth <span class="hljs-keyword">or</span>
                   ih <span class="hljs-keyword">isnt</span> json_data.imageheight
                    <span class="hljs-keyword">throw</span> <span class="hljs-string">'tileset '</span> + tileset.name +
                        <span class="hljs-string">' dimension mismatch ('</span> +
                        iw + <span class="hljs-string">'x'</span> + ih + <span class="hljs-string">' vs '</span> +
                        <span class="hljs-property">@naturalWidth</span> + <span class="hljs-string">'x'</span> + <span class="hljs-property">@naturalHeight</span> + <span class="hljs-string">')'</span>
                
                tileset.setupTileMapping()
                onload?()
            <span class="hljs-property">@image</span>.src = url_prefix + json_data.image
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">setupTileMapping</span>: <span class="hljs-function">-&gt;</span>
            img = <span class="hljs-property">@image</span>
            iw = img.naturalWidth
            ih = img.naturalHeight
            tw = <span class="hljs-property">@tile_width</span>
            th = <span class="hljs-property">@tile_height</span>
            
            margin = <span class="hljs-property">@margin</span>
            twps = tw + <span class="hljs-property">@spacing</span>
            thps = th + <span class="hljs-property">@spacing</span>
            
            numtx = ((iw - margin) / twps) | <span class="hljs-number">0</span>
            numty = ((ih - margin) / thps) | <span class="hljs-number">0</span>
            <span class="hljs-property">@num_tiles</span> = numt = numtx * numty
<span class="hljs-function">            
            <span class="hljs-title">grabTile</span> = <span class="hljs-params">(xiter, yiter)</span> -&gt;</span>
                tcanvas = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'canvas'</span>
                tcanvas.width = tw
                tcanvas.height = th
                
                sx = margin + xiter * twps
                sy = margin + yiter * thps
                
                tctx = tcanvas.getContext <span class="hljs-string">'2d'</span>
                tctx.drawImage img, sx, sy, tw, th, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, tw, th
                
                <span class="hljs-keyword">return</span> tcanvas
            
            <span class="hljs-property">@tiles</span> = (grabTile i % numtx, (i / numtx) | <span class="hljs-number">0</span> \
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..numt])
            
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">hasGID</span>: <span class="hljs-function"><span class="hljs-params">(gid)</span> -&gt;</span> <span class="hljs-property">@first_gid</span> &lt;= gid &lt; <span class="hljs-property">@first_gid</span> + <span class="hljs-property">@num_tiles</span>
        
        <span class="hljs-attribute">drawTile</span>: <span class="hljs-function"><span class="hljs-params">(context, gid, flip_h, flip_v, flip_d, x, y)</span> -&gt;</span>
            idx = gid - <span class="hljs-property">@first_gid</span>
            tw = <span class="hljs-property">@tile_width</span>
            th = <span class="hljs-property">@tile_height</span>
            
            context.save()
            
            context.translate x, y
            context.transform -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, tw, <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> flip_h
            context.transform <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, th <span class="hljs-keyword">if</span> flip_v
            context.transform <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> flip_d
            
            context.drawImage <span class="hljs-property">@tiles</span>[idx], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
            
            context.restore()
            <span class="hljs-keyword">return</span>
    
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Layer</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(json_data, <span class="hljs-property">@map</span>)</span> -&gt;</span>
            <span class="hljs-property">@name</span> = json_data.name
            <span class="hljs-property">@type</span> = json_data.type
            <span class="hljs-property">@properties</span> = json_data.properties
            <span class="hljs-property">@visible</span> = json_data.visible
            <span class="hljs-property">@opacity</span> = json_data.opacity
            <span class="hljs-property">@x</span> = json_data.x
            <span class="hljs-property">@y</span> = json_data.y
            <span class="hljs-property">@width</span> = json_data.width
            <span class="hljs-property">@height</span> = json_data.height
            <span class="hljs-keyword">return</span>
    
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TileLayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Layer</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(json_data, map)</span> -&gt;</span>
            <span class="hljs-keyword">super</span> json_data, map
            
            <span class="hljs-keyword">unless</span> <span class="hljs-property">@type</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'tilelayer'</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-string">"can't construct TileLayer from <span class="hljs-subst">#{<span class="hljs-property">@type</span>}</span> layer"</span>
<span class="hljs-function">            
            <span class="hljs-title">parseGID</span> = <span class="hljs-params">(gid)</span> -&gt;</span>
                flip_h = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Javascript uses 32-bit signed bitwise ops, but
values are written to json unsigned in Tiled.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> gid &gt; <span class="hljs-number">2147483648</span>
                    flip_h = <span class="hljs-literal">true</span>
                    gid -= <span class="hljs-number">2147483648</span>
                flip_v = <span class="hljs-keyword">if</span> gid &amp; <span class="hljs-number">1073741824</span> <span class="hljs-keyword">then</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>
                flip_d = <span class="hljs-keyword">if</span> gid &amp; <span class="hljs-number">536870912</span> <span class="hljs-keyword">then</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>
                gid &amp;= ~<span class="hljs-number">1610612736</span>
                [gid, flip_h, flip_v, flip_d]
            
            width = <span class="hljs-property">@width</span>
            height = <span class="hljs-property">@height</span>
            <span class="hljs-property">@data</span> = (parseGID(json_data.data[i + j * width]) \
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..height] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..width])</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Parallax can be set in tile layer properties in Tiled.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-property">@properties</span>?.parallax?
                <span class="hljs-property">@parallax</span> = +<span class="hljs-property">@properties</span>.parallax
            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@parallax</span> = <span class="hljs-number">1</span>
            
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">buildCache</span>: <span class="hljs-function">-&gt;</span>
            layer = <span class="hljs-keyword">this</span>
            lcf = layer_cache_factor
            w = <span class="hljs-property">@width</span>
            h = <span class="hljs-property">@height</span>
            tw = <span class="hljs-property">@map</span>.tilewidth
            th = <span class="hljs-property">@map</span>.tileheight
            <span class="hljs-property">@cache_width</span> = cw = Math.ceil(w / lcf)
            <span class="hljs-property">@cache_height</span> = ch = Math.ceil(h / lcf)
<span class="hljs-function">            
            <span class="hljs-title">cacheBlock</span> = <span class="hljs-params">(bi, bj)</span> -&gt;</span>
                nbx = Math.min lcf, w - bi
                nby = Math.min lcf, h - bj
                
                canvas = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'canvas'</span>
                canvas.width = tw * nbx
                canvas.height = th * nby
                
                context = canvas.getContext <span class="hljs-string">'2d'</span>
                layer.drawRaw context, bi, bi + nbx, bj, bj + nby, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
                
                <span class="hljs-keyword">return</span> canvas
            
            <span class="hljs-property">@cache</span> = (cacheBlock i * lcf, j * lcf \
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..ch] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span> \
                    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..cw] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>)
            
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">drawRaw</span>: <span class="hljs-function"><span class="hljs-params">(context, lowtx, hightx, lowty, highty, dx, dy)</span> -&gt;</span>
            map = <span class="hljs-property">@map</span>
            tw = map.tilewidth
            th = map.tileheight
            data = <span class="hljs-property">@data</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [lowtx...hightx] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [lowty...highty] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
                    datum = data[i][j]
                    map.drawTile context,
                        datum[<span class="hljs-number">0</span>], datum[<span class="hljs-number">1</span>], datum[<span class="hljs-number">2</span>], datum[<span class="hljs-number">3</span>],
                        dx + (i - lowtx) * tw,
                        dy + (j - lowty) * th
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(context, targx, targy)</span> -&gt;</span>
            map = <span class="hljs-property">@map</span>
            cam = map.camera
            cambounds = cam.shape.bounds_offsets
            
            tw = map.tilewidth
            th = map.tileheight
            
            mlcamxwp = cam.x * <span class="hljs-property">@parallax</span> - <span class="hljs-property">@x</span> * tw
            mlcamywp = cam.y * <span class="hljs-property">@parallax</span> - <span class="hljs-property">@y</span> * th
            
            w = cambounds[<span class="hljs-number">1</span>] - cambounds[<span class="hljs-number">0</span>]
            h = cambounds[<span class="hljs-number">3</span>] - cambounds[<span class="hljs-number">2</span>]
            
            destx = targx - mlcamxwp
            desty = targy - mlcamywp
            
            mlsx = mlcamxwp + cambounds[<span class="hljs-number">0</span>]
            mlsy = mlcamywp + cambounds[<span class="hljs-number">2</span>]
            
            context.save()
            
            context.beginPath()
            cam.shapeSubpath context, targx - cam.x, targy - cam.y
            context.clip()
            
            context.globalAlpha *= <span class="hljs-property">@opacity</span>
            
            <span class="hljs-keyword">if</span> layers_cached
                cache = <span class="hljs-property">@cache</span>
                lcf = layer_cache_factor
                bw = tw * lcf
                bh = th * lcf
                lowbx = Math.max <span class="hljs-number">0</span>, (mlsx / bw) | <span class="hljs-number">0</span>
                highbx = Math.min <span class="hljs-property">@cache_width</span>,
                    Math.ceil((mlsx + w) / bw)
                lowby = Math.max <span class="hljs-number">0</span>, (mlsy / bh) | <span class="hljs-number">0</span>
                highby = Math.min <span class="hljs-property">@cache_height</span>,
                    Math.ceil((mlsy + h) / bh)
                
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [lowbx...highbx] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
                    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [lowby...highby] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
                        context.drawImage cache[i][j],
                            (<span class="hljs-number">.5</span> + destx + i * bw) | <span class="hljs-number">0</span>,
                            (<span class="hljs-number">.5</span> + desty + j * bh) | <span class="hljs-number">0</span>
            <span class="hljs-keyword">else</span>
                lowtx = Math.max <span class="hljs-number">0</span>, (mlsx / tw) | <span class="hljs-number">0</span>
                hightx = Math.min <span class="hljs-property">@width</span>, Math.ceil((mlsx + w) / tw)
                lowty = Math.max <span class="hljs-number">0</span>, (mlsy / th) | <span class="hljs-number">0</span>
                highty = Math.min <span class="hljs-property">@height</span>, Math.ceil((mlsy + h) / th)
                
                <span class="hljs-property">@drawRaw</span> context, lowtx, hightx, lowty, highty,
                    (<span class="hljs-number">.5</span> + destx + lowtx * tw) | <span class="hljs-number">0</span>,
                    (<span class="hljs-number">.5</span> + desty + lowty * th) | <span class="hljs-number">0</span>
                
            context.restore()
            <span class="hljs-keyword">return</span>
    
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObjectLayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Layer</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(json_data, map)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Bitmasks are created from a comma-separated list of
integers from 0-31. They are used to determine collision
groups for zones and obstruction groups.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">            <span class="hljs-title">tryMakingBitmaskFromString</span> = <span class="hljs-params">(bitmask_str)</span> -&gt;</span>
                <span class="hljs-keyword">if</span> bitmask_str?
                    <span class="hljs-keyword">return</span> constructBitmask bitmask_str.split <span class="hljs-string">','</span>
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
<span class="hljs-function">            
            <span class="hljs-title">tryGettingCallbackForName</span> = <span class="hljs-params">(name)</span> -&gt;</span>
                <span class="hljs-keyword">if</span> name?
                    callback = map.script[name]
                    <span class="hljs-keyword">if</span> callback?
                        <span class="hljs-keyword">return</span> callback
                    <span class="hljs-keyword">else</span>
                        <span class="hljs-keyword">throw</span> <span class="hljs-string">"missing callback <span class="hljs-subst">#{name}</span>!"</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
            
            {Point, Aabb, Polyline, Polygon} = geometry
            {Entity} = entity
            {constructBitmask} = util
            
            <span class="hljs-keyword">super</span> json_data, map
            
            <span class="hljs-keyword">unless</span> <span class="hljs-property">@type</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'objectgroup'</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-string">"can't construct ObjectLayer from <span class="hljs-subst">#{<span class="hljs-property">@type</span>}</span> layer"</span>
            
            objects = json_data.objects
            <span class="hljs-property">@entities</span> = []
            mapents = map.entities
            
            l_collides = tryMakingBitmaskFromString \
                <span class="hljs-property">@properties</span>?.collides
            l_onCollide = tryGettingCallbackForName \
                <span class="hljs-property">@properties</span>?.onCollide
            
            l_obstructs = tryMakingBitmaskFromString \
                <span class="hljs-property">@properties</span>?.obstructs
            l_onObstruct = tryGettingCallbackForName \
                <span class="hljs-property">@properties</span>?.onObstruct
<span class="hljs-function">            
            <span class="hljs-title">setupEntityWithProperties</span> = <span class="hljs-params">(ent, object)</span> -&gt;</span>
                ent.onStart = tryGettingCallbackForName \
                    object.properties?.onStart</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Object level callbacks are preferred over layer
level callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                
                obj_onCollide = tryGettingCallbackForName \
                    object.properties?.onCollide
                
                <span class="hljs-keyword">if</span> obj_onCollide?
                    ent.onCollide = obj_onCollide
                <span class="hljs-keyword">else</span>
                    ent.onCollide = l_onCollide
                
                obj_onObstruct = tryGettingCallbackForName \
                    object.properties?.onObstruct
                
                <span class="hljs-keyword">if</span> obj_onObstruct?
                    ent.onObstruct = obj_onObstruct
                <span class="hljs-keyword">else</span>
                    ent.onObstruct = l_onObstruct</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>These objects are assumed not to move, so they
may act as static obstructions/zones.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                ent.static = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Bitmasks from the object and layer are combined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                obj_collides = tryMakingBitmaskFromString \
                    object.properties?.collides
                ent.collides = l_collides | obj_collides
                
                obj_obstructs = tryMakingBitmaskFromString \
                    object.properties?.obstructs
                ent.obstructs = l_obstructs | obj_obstructs
                
                <span class="hljs-keyword">return</span>
            
            <span class="hljs-keyword">for</span> object <span class="hljs-keyword">in</span> objects
                objx = object.x
                objy = object.y
                objw = object.width
                objh = object.height
                
                <span class="hljs-keyword">if</span> object.polygon?
                    ent = <span class="hljs-keyword">new</span> Entity objx, objy,
                        <span class="hljs-keyword">new</span> Polygon ([point.x, point.y] \
                            <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> object.polygon)
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> object.polyline?</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Polylines are modeled as multiple polygons.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..object.polyline.length - <span class="hljs-number">1</span>] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
                        point_a = object.polyline[i]
                        point_b = object.polyline[i + <span class="hljs-number">1</span>]
                        ent = <span class="hljs-keyword">new</span> Entity objx, objy,
                            <span class="hljs-keyword">new</span> Polygon [[point_a.x, point_a.y],
                                [point_b.x, point_b.y]]
                        
                        setupEntityWithProperties ent, object
                        <span class="hljs-property">@addEntity</span> ent
                    <span class="hljs-keyword">continue</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> objw <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> objh <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
                    ent = <span class="hljs-keyword">new</span> Entity objx, objy, <span class="hljs-keyword">new</span> Point
                <span class="hljs-keyword">else</span>
                    objhwx = <span class="hljs-number">.5</span> * objw
                    objhwy = <span class="hljs-number">.5</span> * objh
                    ent = <span class="hljs-keyword">new</span> Entity objx + objhwx, objy + objhwy,
                        <span class="hljs-keyword">new</span> Aabb [objhwx, objhwy]
                
                setupEntityWithProperties ent, object
                <span class="hljs-property">@addEntity</span> ent
            
            <span class="hljs-property">@entities</span>.sort byBottomBound
            <span class="hljs-property">@onStart</span> = tryGettingCallbackForName <span class="hljs-property">@properties</span>?.onStart
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">addEntity</span>: <span class="hljs-function"><span class="hljs-params">(ent)</span> -&gt;</span>
            ent.layer = <span class="hljs-keyword">this</span>
            ent.map = <span class="hljs-property">@map</span>
            <span class="hljs-property">@entities</span>.push ent
            <span class="hljs-property">@map</span>.entities.push ent
        
        <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(context, targx, targy)</span> -&gt;</span>
            map = <span class="hljs-property">@map</span>
            cam = map.camera
            
            xoff = targx - cam.x - <span class="hljs-property">@x</span> * map.tilewidth
            yoff = targy - cam.y - <span class="hljs-property">@y</span> * map.tileheight
            
            ents = <span class="hljs-property">@entities</span>
            util.persistentSort ents, byBottomBound
            <span class="hljs-keyword">for</span> ent <span class="hljs-keyword">in</span> ents
                ent.draw? context, xoff, yoff
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">debugDraw</span>: <span class="hljs-function"><span class="hljs-params">(context, targx, targy)</span> -&gt;</span>
            map = <span class="hljs-property">@map</span>
            cam = map.camera
            cambounds = cam.shape.bounds_offsets
            camlx = cam.x + cambounds[<span class="hljs-number">0</span>]
            camly = cam.y + cambounds[<span class="hljs-number">2</span>]
            w = cambounds[<span class="hljs-number">1</span>] - cambounds[<span class="hljs-number">0</span>]
            h = cambounds[<span class="hljs-number">3</span>] - cambounds[<span class="hljs-number">2</span>]
            destx = targx + cambounds[<span class="hljs-number">0</span>]
            desty = targy + cambounds[<span class="hljs-number">2</span>]
            
            xoff = destx - camlx - <span class="hljs-property">@x</span> * <span class="hljs-property">@map</span>.tilewidth
            yoff = desty - camly - <span class="hljs-property">@y</span> * <span class="hljs-property">@map</span>.tileheight
            
            context.save()
            context.beginPath()
            context.globalAlpha *= <span class="hljs-number">.75</span>
            
            <span class="hljs-keyword">for</span> ent <span class="hljs-keyword">in</span> <span class="hljs-property">@entities</span>
                <span class="hljs-keyword">if</span> ent.boundsIntersects cam
                    ent.shapeSubpath context, xoff, yoff
            
            context.stroke()
            
            context.restore()
            <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Maps are loaded from a URL containing <code>@name</code> and callbacks are
searched for inside of the <code>@script</code> passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">Map</span>: <span class="hljs-class"><span class="hljs-keyword">class</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@name</span>, <span class="hljs-property">@script</span>, onload)</span> -&gt;</span>
            <span class="hljs-property">@loaded</span> = <span class="hljs-literal">false</span>
            <span class="hljs-property">@entities</span> = []
            cb_target = <span class="hljs-keyword">this</span>
            $.getJSON url_prefix + <span class="hljs-property">@name</span> + url_suffix,
                <span class="hljs-function">(<span class="hljs-params">(data)</span> -&gt;</span> cb_target.load(data, onload); <span class="hljs-keyword">return</span>)
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">load</span>: <span class="hljs-function"><span class="hljs-params">(json_data, onload)</span> -&gt;</span>
            <span class="hljs-keyword">unless</span> json_data.orientation <span class="hljs-keyword">is</span> <span class="hljs-string">'orthogonal'</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-string">"orientation <span class="hljs-subst">#{orientation}</span> not supported"</span>
            
            <span class="hljs-property">@width</span> = json_data.width
            <span class="hljs-property">@height</span> = json_data.height
            <span class="hljs-property">@tilewidth</span> = json_data.tilewidth
            <span class="hljs-property">@tileheight</span> = json_data.tileheight
            <span class="hljs-property">@orientation</span> = json_data.orientation
            <span class="hljs-property">@properties</span> = json_data.properties
            
            map = <span class="hljs-keyword">this</span>
<span class="hljs-function">            
            <span class="hljs-title">createLayer</span> = <span class="hljs-params">(data)</span> -&gt;</span>
                {type} = data
                <span class="hljs-keyword">if</span> type <span class="hljs-keyword">is</span> <span class="hljs-string">'tilelayer'</span>
                    <span class="hljs-keyword">new</span> TileLayer data, map
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> type <span class="hljs-keyword">is</span> <span class="hljs-string">'objectgroup'</span>
                    <span class="hljs-keyword">new</span> ObjectLayer data, map
                <span class="hljs-keyword">else</span>
                    <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"unknown layer type <span class="hljs-subst">#{type}</span> requested"</span>
                    <span class="hljs-keyword">new</span> Layer data, map
            
            <span class="hljs-property">@layers</span> = (createLayer l <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> json_data.layers)
            
            {tilesets} = json_data
            tileset_load_total = tilesets.length
            tileset_load_count = <span class="hljs-number">0</span>
<span class="hljs-function">            <span class="hljs-title">ts_load_cb</span> = -&gt;</span>
                <span class="hljs-keyword">if</span> ++tileset_load_count &gt;= tileset_load_total
                    map.buildLayerCaches() <span class="hljs-keyword">if</span> layers_cached
                    map.loaded = <span class="hljs-literal">true</span>
                    onload?()
                <span class="hljs-keyword">return</span>
            
            <span class="hljs-property">@tilesets</span> = (<span class="hljs-keyword">new</span> TileSet ts, ts_load_cb <span class="hljs-keyword">for</span> ts <span class="hljs-keyword">in</span> tilesets)
            
            <span class="hljs-property">@entities</span>.sort byLeftBound
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">buildLayerCaches</span>: <span class="hljs-function">-&gt;</span>
            <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-property">@layers</span> <span class="hljs-keyword">when</span> layer.type <span class="hljs-keyword">is</span> <span class="hljs-string">'tilelayer'</span>
                layer.buildCache()
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">drawTile</span>: <span class="hljs-function"><span class="hljs-params">(context, gid, flip_h, flip_v, flip_d, x, y)</span> -&gt;</span>
            <span class="hljs-keyword">for</span> tileset <span class="hljs-keyword">in</span> <span class="hljs-property">@tilesets</span>
                <span class="hljs-keyword">if</span> tileset.hasGID gid
                    tileset.drawTile context,
                        gid, flip_h, flip_v, flip_d, x, y
                    <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">doCollisions</span>: <span class="hljs-function">-&gt;</span>
            ents = <span class="hljs-property">@entities</span>
            util.persistentSort ents, byLeftBound
            j = <span class="hljs-number">0</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span>..ents.length] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
                enti = <span class="hljs-property">@entities</span>[i]
                
                <span class="hljs-keyword">while</span> j &lt; i <span class="hljs-keyword">and</span>
                  ents[j].x + ents[j].shape.bounds_offsets[<span class="hljs-number">1</span>] &lt;
                  enti.x + enti.shape.bounds_offsets[<span class="hljs-number">0</span>]
                    ++j
                
                <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> [j...i] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
                    <span class="hljs-property">@doCollision</span> enti, <span class="hljs-property">@entities</span>[k]
            
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">doCollision</span>: <span class="hljs-function"><span class="hljs-params">(ent_a, ent_b)</span> -&gt;</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> ent_a.static <span class="hljs-keyword">and</span> ent_b.static
            
            can_collide = (ent_a.collides &amp; ent_b.collides)
            can_obstruct = (ent_a.obstructs &amp; ent_b.obstructs)
            
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> can_collide <span class="hljs-keyword">or</span> can_obstruct
            
            collision_info = ent_a.intersects ent_b
            
            <span class="hljs-keyword">if</span> collision_info
                [pen_amt, pen_dir] = collision_info
                
                neg_collision_info = 
                    [pen_amt, [-pen_dir[<span class="hljs-number">0</span>], -pen_dir[<span class="hljs-number">1</span>]]]
                
                ent_a.onCollide? ent_b, collision_info
                ent_b.onCollide? ent_a, neg_collision_info
                
                <span class="hljs-keyword">if</span> can_obstruct
                    proj_x = pen_amt * pen_dir[<span class="hljs-number">0</span>]
                    proj_y = pen_amt * pen_dir[<span class="hljs-number">1</span>]
                    <span class="hljs-keyword">if</span> ent_a.static
                        ent_b.x += proj_x
                        ent_b.y += proj_y
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ent_b.static
                        ent_a.x -= proj_x
                        ent_a.y -= proj_y
                    <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>For now, splits the resolution 50-50 between
dynamic objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        rat = <span class="hljs-number">.5</span>
                        notrat = <span class="hljs-number">1</span> - rat
                        
                        ent_a.x -= rat * proj_x
                        ent_a.y -= rat * proj_y
                        ent_b.x += notrat * proj_x
                        ent_b.y += notrat * proj_y
                    
                    ent_a.onObstruct? ent_b, collision_info
                    ent_b.onObstruct? ent_a, neg_collision_info
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">start</span>: <span class="hljs-function">-&gt;</span>
            <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-property">@layers</span>
                layer.onStart? layer
            <span class="hljs-keyword">for</span> ent <span class="hljs-keyword">in</span> <span class="hljs-property">@entities</span>
                ent.onStart? ent
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">update</span>: <span class="hljs-function"><span class="hljs-params">(dt)</span> -&gt;</span>
            <span class="hljs-keyword">for</span> ent <span class="hljs-keyword">in</span> <span class="hljs-property">@entities</span>
                ent.update? dt
            <span class="hljs-property">@doCollisions</span>()
            <span class="hljs-property">@camera</span>.post_update? dt
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(context, targx, targy)</span> -&gt;</span>
            <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-property">@layers</span>
                layer.draw context, targx, targy
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">debugDraw</span>: <span class="hljs-function"><span class="hljs-params">(context, targx, targy)</span> -&gt;</span>
            cam = <span class="hljs-property">@camera</span>
            xoff = targx - cam.x
            yoff = targy - cam.y
            
            found_first = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@entities</span>.length] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
                ent = <span class="hljs-property">@entities</span>[i]
                <span class="hljs-keyword">if</span> ent.boundsIntersects cam
                    ent.shapeSubpath context, xoff, yoff
                    found_first = <span class="hljs-literal">true</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> found_first <span class="hljs-keyword">and</span> cam.boundsLeftOf ent
                    <span class="hljs-keyword">break</span>
            
            <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-property">@layers</span> <span class="hljs-keyword">when</span> layer.type <span class="hljs-keyword">is</span> <span class="hljs-string">'objectgroup'</span>
                layer.debugDraw context, targx, targy
            
            <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>A scene for running a map.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">MapScene</span>: <span class="hljs-class"><span class="hljs-keyword">class</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@map</span>)</span> -&gt;</span>
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">start</span>: <span class="hljs-function">-&gt;</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@map</span>.name}</span> not loaded!"</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@map</span>.loaded
            {Entity} = entity
            {Aabb} = geometry</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Camera is initially positioned at the origin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@map</span>.camera = <span class="hljs-keyword">new</span> Entity <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,
                <span class="hljs-keyword">new</span> Aabb [<span class="hljs-number">.5</span> * game.width(), <span class="hljs-number">.5</span> * game.height()]
            
            <span class="hljs-property">@map</span>.entities.push <span class="hljs-property">@map</span>.camera
            
            <span class="hljs-property">@map</span>.start()
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">end</span>: <span class="hljs-function">-&gt;</span>
        
        <span class="hljs-attribute">update</span>: <span class="hljs-function"><span class="hljs-params">(dt)</span> -&gt;</span>
            <span class="hljs-property">@map</span>.update dt
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(context)</span> -&gt;</span>
            gw = game.width()
            gh = game.height()
            hgw = <span class="hljs-number">.5</span> * gw
            hgh = <span class="hljs-number">.5</span> * gh
            
            context.clearRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, gw, gh
            context.beginPath()
            
            <span class="hljs-property">@map</span>.draw context, hgw, hgh</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>@map.debugDraw context, hgw, hgh</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            
            <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
