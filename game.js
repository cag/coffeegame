(function(){define("util",[],function(){var e,t,n;return t=0,n=0,e=function(e,t){var n,r,i,s,o;t==null&&(t=function(e,t){return e<t?-1:e===t?0:1});for(n=s=1,o=e.length;1<=o?s<o:s>o;n=1<=o?++s:--s){i=e[n],r=n;while(r>0&&t(e[r-1],i)>0)e[r]=e[r-1],--r;e[r]=i}},function(){var e,t,n,r,i,s,o,u;i=window,u=["ms","moz","webkit","o"];for(s=0,o=u.length;s<o;s++){r=u[s];if(i.requestAnimationFrame)break;i.requestAnimationFrame=i[r+"RequestAnimationFrame"],i.cancelAnimationFrame=i[r+"CancelAnimationFrame"]||i[""+r+"CancelRequestAnimationFrame"]}if(i.requestAnimationFrame){if(i.cancelAnimationFrame)return;e=i.requestAnimationFrame,t={},i.requestAnimationFrame=function(n){var r;return r=e(function(e){return r in t?delete t[r]:n(e)})},i.cancelAnimationFrame=function(e){return t[e]=!0}}else n=0,i.requestAnimationFrame=function(e){var t;return n=Math.max(n+16,t=+(new Date)),i.setTimeout(function(){return e(+(new Date))},n-t)},i.cancelAnimationFrame=function(e){return clearTimeout(e)}}(),{EPSILON:1/Math.pow(2,50),time:function(){var e;return e=Date.now(),e<n&&(t+=n-e),n=e,.001*(e+t)},persistentSort:e,constructBitmask:function(e){var t,n,r,i;n=0;for(r=0,i=e.length;r<i;r++)t=e[r],n|=1<<t;return n},rgbToHex:function(e,t,n){var r;return r=function(e){return("00"+Math.min(Math.max(Math.round(e*256),0),255).toString(16)).substr(-2)},"#"+r(e)+r(t)+r(n)}}})}).call(this),function(){define("input",[],function(){return{buttons:{left:37,up:38,right:39,down:40,jump:90},init:function(){var e,t;t=[];for(e in this.buttons)t.push(this[e]={});return t},update:function(){var e,t;t=function(e){e.state?e.last_state?e.pressed=!1:e.pressed=!0:e.last_state?e.released=!0:e.released=!1,e.last_state=e.state};for(e in this.buttons)t(this[e])},handleKeyDown:function(e){var t,n,r;r=this.buttons;for(n in r)t=r[n],e===t&&(this[n].state=!0)},handleKeyUp:function(e){var t,n,r;r=this.buttons;for(n in r)t=r[n],e===t&&(this[n].state=!1)}}})}.call(this),function(){define("audio",[],function(){var e;return function(){var e;e=window,e.AudioContext=e.AudioContext||e.webkitAudioContext}(),e=null,{init:function(){typeof AudioContext!="undefined"&&AudioContext!==null?e=new AudioContext:console.warn("could not initialize audio!")},getAudioContext:function(){return e},Sound:function(){function t(t,n){var r,i;if(e==null){typeof n=="function"&&n();return}i=new XMLHttpRequest,i.open("GET",t,!0),i.responseType="arraybuffer",r=this,i.onload=function(){return e.decodeAudioData(i.response,function(e){r.buffer=e,typeof n=="function"&&n()},function(){throw"could not load sound buffer from "+t})},i.send();return}return t.prototype.play=function(t,n,r){var i;return t==null&&(t=0),n==null&&(n=!1),e!=null&&this.buffer!=null?(i=e.createBufferSource(),i.buffer=this.buffer,i.loop=n,i.connect(r||e.destination),i.noteOn(t+e.currentTime),i):null},t}()}})}.call(this),function(){define("game",["./util","./input","./audio"],function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m;return r=null,o=null,s=0,i=0,u=null,d=null,p=null,l=null,f=50,v=!0,c=function(e){t.handleKeyDown(e.keyCode)},h=function(e){t.handleKeyUp(e.keyCode)},m=function(e){t.update(),u.update(e)},a=function(){u.draw(o)},{width:function(){return s},height:function(){return i},lastDt:function(){return d},invLastDt:function(){return p},switchScene:function(e){if(e==null)throw"cannot switch to nonexistent scene";u.end(),u=e,u.start()},init:function(e,a,v,m,g){u=g,v!=null?(l=v,d=l,p=1/l):m!=null?(f=m,d=f,p=1/f):(d=1/60,p=60),r=document.createElement("canvas"),r.width=s=e,r.height=i=a,r.tabIndex=1,o=r.getContext("2d"),document.body.appendChild(r),r.focus(),t.init(),r.addEventListener("keydown",c,!1),r.addEventListener("keyup",h,!1),n.init()},run:function(){var t,n,r,i,s;if(u==null)throw"no current scene!";i=window.requestAnimationFrame,s=e.time,r=s(),t=0,v=!1,n=function(){var e,o;v||i(n),o=s(),e=o-r,e=e>f?f:e,r=o;if(l!=null){t+=e;while(t>l)m(l),t-=l}else m(e),d=e,p=1/e;return a()},u.start(),n()}}})}.call(this),function(){define("geometry",[],function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;return r=2,n=4,t=2,e=Math.pow(2,-50),o=function(e,t){return e[0]*t[0]+e[1]*t[1]},f=function(e){var t;return t=1/Math.sqrt(o(e,e)),[t*e[0],t*e[1]]},l=function(e,t){var n,r,i,s,u,a,f,l,c;i=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,f=e.type;if(f==="Point")i=0,r=0;else if(f==="Aabb")n=o(e.halfwidth,t),n<0?(i=Math.min(i,n),r=Math.max(r,-n)):(i=Math.min(i,-n),r=Math.max(r,n)),n=o([e.halfwidth[0],-e.halfwidth[1]],t),n<0?(i=Math.min(i,n),r=Math.max(r,-n)):(i=Math.min(i,-n),r=Math.max(r,n));else if(f==="Polygon"){a=e.points;for(l=0,c=a.length;l<c;l++)s=a[l],u=o(s,t),i=Math.min(i,u),r=Math.max(r,u)}return[i,r]},a=function(e,t){var n,r;return e[1]<t[0]||t[1]<e[0]?!1:(n=t[1]-e[0],r=e[1]-t[0],n<r?-n:r)},s=function(e,t,n,r,i,s,u,f,c){var h,p,d,v,m,g,y,b,w,E;u==null&&(u=Number.POSITIVE_INFINITY),c==null&&(c=!1);for(p=w=0,E=r.normals.length;w<E;p=w+=1){v=r.normals[p],m=r.bounds_on_normals[p],y=o([t,n],v),g=o([i,s],v),b=l(e,v),d=a([b[0]+y,b[1]+y],[m[0]+g,m[1]+g]);if(!d)return!1;h=Math.abs(d),h<u&&(u=h,c===d<0?f=v:f=[-v[0],-v[1]])}return[u,f]},i=function(e){var t,n,r,i,s,o,u;r=e[0][0],t=e[0][0],i=e[0][1],n=e[0][1];for(o=0,u=e.length;o<u;o++)s=e[o],r=Math.min(r,s[0]),t=Math.max(t,s[0]),i=Math.min(i,s[1]),n=Math.max(n,s[1]);return[r,t,i,n]},d=function(e,t,n,r,i,s){return[0,[1,0]]},p=function(e,t,n,r,i,s){var o,u,a;return u=i+r.halfwidth[0]-t,a=[-1,0],o=s+r.halfwidth[1]-n,o<u&&(u=o,a=[0,-1]),o=t-(i-r.halfwidth[0]),o<u&&(u=o,a=[1,0]),o=n-(s-r.halfwidth[1]),o<u&&(u=o,a=[0,1]),[u,a]},v=function(e,t,n,r,i,o){return s(e,t,n,r,i,o)},c=function(e,t,n,r,i,s){var o,u,a;return u=i+r.halfwidth[0]-(t-e.halfwidth[0]),a=[-1,0],o=s+r.halfwidth[1]-(n-e.halfwidth[1]),o<u&&(u=o,a=[0,-1]),o=t+e.halfwidth[0]-(i-r.halfwidth[0]),o<u&&(u=o,a=[1,0]),o=n+e.halfwidth[1]-(s-r.halfwidth[1]),o<u&&(u=o,a=[0,1]),[u,a]},h=function(e,t,n,r,i,o){var u,f,l;return u=a([t+e.bounds_offsets[0],t+e.bounds_offsets[1]],[i+r.bounds_offsets[0],i+r.bounds_offsets[1]]),u<0?(f=-u,l=[-1,0]):(f=u,l=[1,0]),u=a([n+e.bounds_offsets[2],n+e.bounds_offsets[3]],[o+r.bounds_offsets[2],o+r.bounds_offsets[3]]),u<0?(f=-u,l=[0,-1]):(f=u,l=[0,1]),s(e,t,n,r,i,o,f,l)},m=function(e,t,n,r,i,o){var u,a,f;return f=s(e,t,n,r,i,o),f?(u=f[0],a=f[1],s(r,i,o,e,t,n,u,a,!0)):!1},u={Point:{Point:d,Aabb:p,Polygon:v},Aabb:{Aabb:c,Polygon:h},Polygon:{Polygon:m}},{dotProduct:o,Point:function(){function e(){this.type="Point",this.bounds_offsets=[0,0,0,0]}return e.prototype.subpath=function(e,t,n){e.moveTo(t+r,n),e.arc(t,n,r,0,2*Math.PI)},e}(),Aabb:function(){function e(e){var t;this.halfwidth=e,this.type="Aabb",t=this.halfwidth,this.bounds_offsets=[-t[0],t[0],-t[1],t[1]];return}return e.prototype.subpath=function(e,t,n){var r;r=this.halfwidth,e.rect(t-r[0],n-r[1],2*r[0],2*r[1])},e}(),Polygon:function(){function s(t){var n,r,s,u,a,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A;this.type="Polygon",this.bounds_offsets=i(t),S=0,x=0,g=t.length;for(T=0,L=t.length;T<L;T++)b=t[T],S+=b[0],x+=b[1];this.center_offset=[S/g,x/g],s=null,w=t.length;for(h=N=0;N<w;h=N+=1){p=(h+1)%w,d=(h+2)%w,a=[t[p][0]-t[h][0],t[p][1]-t[h][1]],c=[t[d][0]-t[p][0],t[d][1]-t[p][1]],u=a[0]*c[1]-c[0]*a[1];if(s!=null){if(s&&u>0||!s&&u<0)throw"tried to construct non-convex polygon"}else s=u<0}s?this.points=t.reverse():this.points=t,m=[],r=[];for(h=C=0;C<w;h=C+=1){p=(h+1)%w,v=f([this.points[h][1]-this.points[p][1],this.points[p][0]-this.points[h][0]]),E=!1;for(k=0,A=m.length;k<A;k++){y=m[k];if(Math.abs(o(v,y))>1-e){E=!0;continue}}if(E)continue;n=l(this,v),m.push(v),r.push(n)}this.normals=m,this.bounds_on_normals=r;return}return s.prototype.subpath=function(e,i,s){var o,u,a,f,l,c,h,p,d,v;l=this.points,e.moveTo(l[0][0]+i,l[0][1]+s);for(a=c=1,d=l.length;c<d;a=c+=1)e.lineTo(l[a][0]+i,l[a][1]+s);e.closePath(),o=i+this.center_offset[0],u=s+this.center_offset[1],e.moveTo(o+r,u),e.arc(o,u,r,0,2*Math.PI),v=this.normals;for(h=0,p=v.length;h<p;h++)f=v[h],e.moveTo(o+n*f[0],u+n*f[1]),e.lineTo(o+(t+n)*f[0],u+(t+n)*f[1])},s}(),intersects:function(e,t,n,r,i,s){var o,a,f,l;a=(f=u[i.type])!=null?f[s.type]:void 0;if(a!=null)return a(i,e,n,s,t,r);a=(l=u[s.type])!=null?l[i.type]:void 0;if(a!=null)return o=a(s,t,r,i,e,n),o?[o[0],[-o[1][0],-o[1][1]]]:!1;throw"can't test "+i.type+" against "+s.type}}})}.call(this),function(){define("entity",["./geometry"],function(e){return{Entity:function(){function t(e,t,n){this.x=e,this.y=t,this.shape=n}return t.prototype.shapeSubpath=function(e,t,n){this.shape.subpath(e,this.x+t,this.y+n)},t.prototype.boundsLeftOf=function(e){return this.x+this.shape.bounds_offsets[1]<e.x+e.shape.bounds_offsets[0]},t.prototype.boundsIntersects=function(e){var t,n;return t=this.shape.bounds_offsets,n=e.shape.bounds_offsets,this.x+t[0]<=e.x+n[1]&&this.x+t[1]>=e.x+n[0]&&this.y+t[2]<=e.y+n[3]&&this.y+t[3]>=e.y+n[2]},t.prototype.intersects=function(t){return this.boundsIntersects(t)?e.intersects(this.x,t.x,this.y,t.y,this.shape,t.shape):!1},t}()}})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("map",["jquery","./game","./entity","./geometry","./util"],function(e,n,r,i,s){var o,u,a,f,l,c,h,p,d,v;return p=!0,h=16,d="maps/",v=".json",c=function(e,t){return e.x+e.shape.bounds_offsets[0]-t.x-t.shape.bounds_offsets[0]},l=function(e,t){return e.y+e.shape.bounds_offsets[3]-t.y-t.shape.bounds_offsets[3]},f=function(){function e(e,t){var n;this.name=e.name,this.first_gid=e.firstgid,this.tile_width=e.tilewidth,this.tile_height=e.tileheight,this.margin=e.margin,this.spacing=e.spacing,this.properties=e.properties,n=this,this.image=new Image,this.image.onload=function(){var r,i;i=this.naturalWidth,r=this.naturalHeight;if(i!==e.imagewidth||r!==e.imageheight)throw"tileset "+n.name+" dimension mismatch ("+i+"x"+r+" vs "+this.naturalWidth+"x"+this.naturalHeight+")";return n.setupTileMapping(),typeof t=="function"?t():void 0},this.image.src=d+e.image;return}return e.prototype.setupTileMapping=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h;r=this.image,i=r.naturalWidth,n=r.naturalHeight,c=this.tile_width,f=this.tile_height,s=this.margin,h=c+this.spacing,l=f+this.spacing,u=(i-s)/h|0,a=(n-s)/l|0,this.num_tiles=o=u*a,e=function(e,t){var n,i,o,u;return o=document.createElement("canvas"),o.width=c,o.height=f,n=s+e*h,i=s+t*l,u=o.getContext("2d"),u.drawImage(r,n,i,c,f,0,0,c,f),o},this.tiles=function(){var n,r;r=[];for(t=n=0;0<=o?n<o:n>o;t=0<=o?++n:--n)r.push(e(t%u,t/u|0));return r}()},e.prototype.hasGID=function(e){return this.first_gid<=e&&e<this.first_gid+this.num_tiles},e.prototype.drawTile=function(e,t,n,r,i,s,o){var u,a,f;u=t-this.first_gid,f=this.tile_width,a=this.tile_height,e.save(),e.translate(s,o),n&&e.transform(-1,0,0,1,f,0),r&&e.transform(1,0,0,-1,0,a),i&&e.transform(0,1,1,0,0,0),e.drawImage(this.tiles[u],0,0),e.restore()},e}(),o=function(){function e(e,t){this.map=t,this.name=e.name,this.type=e.type,this.properties=e.properties,this.visible=e.visible,this.opacity=e.opacity,this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height;return}return e}(),a=function(e){function n(e,t){var r,i,s,o,u,a;n.__super__.constructor.call(this,e,t);if(this.type!=="tilelayer")throw"can't construct TileLayer from "+this.type+" layer";o=function(e){var t,n,r;return n=!1,e>2147483648&&(n=!0,e-=2147483648),r=e&1073741824?!0:!1,t=e&536870912?!0:!1,e&=-1610612737,[e,n,r,t]},u=this.width,r=this.height,this.data=function(){var t,n;n=[];for(i=t=0;0<=u?t<u:t>u;i=0<=u?++t:--t)n.push(function(){var t,n;n=[];for(s=t=0;0<=r?t<r:t>r;s=0<=r?++t:--t)n.push(o(e.data[i+s*u]));return n}());return n}(),((a=this.properties)!=null?a.parallax:void 0)!=null?this.parallax=+this.properties.parallax:this.parallax=1;return}return t(n,e),n.prototype.buildCache=function(){var e,t,n,r,i,s,o,u,a,f,l;o=this,u=h,l=this.width,r=this.height,f=this.map.tilewidth,a=this.map.tileheight,this.cache_width=n=Math.ceil(l/u),this.cache_height=t=Math.ceil(r/u),e=function(e,t){var n,i,s,c;return s=Math.min(u,l-e),c=Math.min(u,r-t),n=document.createElement("canvas"),n.width=f*s,n.height=a*c,i=n.getContext("2d"),o.drawRaw(i,e,e+s,t,t+c,0,0),n},this.cache=function(){var r,o;o=[];for(i=r=0;r<n;i=r+=1)o.push(function(){var n,r;r=[];for(s=n=0;n<t;s=n+=1)r.push(e(i*u,s*u));return r}());return o}()},n.prototype.drawRaw=function(e,t,n,r,i,s,o){var u,a,f,l,c,h,p,d,v;c=this.map,p=c.tilewidth,h=c.tileheight,u=this.data;for(f=d=t;d<n;f=d+=1)for(l=v=r;v<i;l=v+=1)a=u[f][l],c.drawTile(e,a[0],a[1],a[2],a[3],s+(f-t)*p,o+(l-r)*h)},n.prototype.draw=function(e,t,n){var r,i,s,o,u,a,f,l,c,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D;T=this.map,o=T.camera,u=o.shape.bounds_offsets,O=T.tilewidth,A=T.tileheight,N=o.x*this.parallax-this.x*O,C=o.y*this.parallax-this.y*A,M=u[1]-u[0],l=u[3]-u[2],a=t-N,f=n-C,k=N+u[0],L=C+u[2],e.save(),e.beginPath(),o.shapeSubpath(e,t-o.x,n-o.y),e.clip(),e.globalAlpha*=this.opacity;if(p){s=this.cache,b=h,i=O*b,r=A*b,w=Math.max(0,k/i|0),c=Math.min(this.cache_width,Math.ceil((k+M)/i)),E=Math.max(0,L/r|0),d=Math.min(this.cache_height,Math.ceil((L+l)/r));for(g=_=w;_<c;g=_+=1)for(y=D=E;D<d;y=D+=1)e.drawImage(s[g][y],.5+a+g*i|0,.5+f+y*r|0)}else S=Math.max(0,k/O|0),v=Math.min(this.width,Math.ceil((k+M)/O)),x=Math.max(0,L/A|0),m=Math.min(this.height,Math.ceil((L+l)/A)),this.drawRaw(e,S,v,x,m,.5+a+S*O|0,.5+f+x*A|0);e.restore()},n}(o),u=function(e){function n(e,t){var o,u,a,f,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U;D=function(e){return e!=null?h(e.split(",")):0},_=function(e){var n;if(e!=null){n=t.script[e];if(n!=null)return n;throw"missing callback "+e+"!"}return null},a=i.Point,o=i.Aabb,c=i.Polyline,f=i.Polygon,u=r.Entity,h=s.constructBitmask,n.__super__.constructor.call(this,e,t);if(this.type!=="objectgroup")throw"can't construct ObjectLayer from "+this.type+" layer";E=e.objects,this.entities=[],b=t.entities,v=D((j=this.properties)!=null?j.collides:void 0),g=_((F=this.properties)!=null?F.onCollide:void 0),m=D((I=this.properties)!=null?I.obstructs:void 0),y=_((q=this.properties)!=null?q.onObstruct:void 0),M=function(e,t){var n,r,i,s,o,u,a,f,l;e.onStart=_((o=t.properties)!=null?o.onStart:void 0),i=_((u=t.properties)!=null?u.onCollide:void 0),i!=null?e.onCollide=i:e.onCollide=g,s=_((a=t.properties)!=null?a.onObstruct:void 0),s!=null?e.onObstruct=s:e.onObstruct=y,e["static"]=!0,n=D((f=t.properties)!=null?f.collides:void 0),e.collides=v|n,r=D((l=t.properties)!=null?l.obstructs:void 0),e.obstructs=m|r};for(P=0,B=E.length;P<B;P++){w=E[P],C=w.x,k=w.y,N=w.width,S=w.height;if(w.polygon!=null)p=new u(C,k,new f(function(){var e,t,n,r;n=w.polygon,r=[];for(e=0,t=n.length;e<t;e++)L=n[e],r.push([L.x,L.y]);return r}()));else{if(w.polyline!=null){for(d=H=0,R=w.polyline.length-1;H<R;d=H+=1)A=w.polyline[d],O=w.polyline[d+1],p=new u(C,k,new f([[A.x,A.y],[O.x,O.y]])),M(p,w),this.addEntity(p);continue}N===0&&S===0?p=new u(C,k,new a):(x=.5*N,T=.5*S,p=new u(C+x,k+T,new o([x,T])))}M(p,w),this.addEntity(p)}this.entities.sort(l),this.onStart=_((U=this.properties)!=null?U.onStart:void 0);return}return t(n,e),n.prototype.addEntity=function(e){return e.layer=this,e.map=this.map,this.entities.push(e),this.map.entities.push(e)},n.prototype.draw=function(e,t,n){var r,i,o,u,a,f,c,h;u=this.map,r=u.camera,a=t-r.x-this.x*u.tilewidth,f=n-r.y-this.y*u.tileheight,o=this.entities,s.persistentSort(o,l);for(c=0,h=o.length;c<h;c++)i=o[c],typeof i.draw=="function"&&i.draw(e,a,f)},n.prototype.debugDraw=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;c=this.map,r=c.camera,i=r.shape.bounds_offsets,s=r.x+i[0],o=r.y+i[2],h=i[1]-i[0],l=i[3]-i[2],u=t+i[0],a=n+i[2],p=u-s-this.x*this.map.tilewidth,d=a-o-this.y*this.map.tileheight,e.save(),e.beginPath(),e.globalAlpha*=.75,g=this.entities;for(v=0,m=g.length;v<m;v++)f=g[v],f.boundsIntersects(r)&&f.shapeSubpath(e,p,d);e.stroke(),e.restore()},n}(o),{Map:function(){function t(t,n,r){var i;this.name=t,this.script=n,this.loaded=!1,this.entities=[],i=this,e.getJSON(d+this.name+v,function(e){i.load(e,r)});return}return t.prototype.load=function(e,t){var n,r,i,s,l,h,d,v;if(e.orientation!=="orthogonal")throw"orientation "+orientation+" not supported";this.width=e.width,this.height=e.height,this.tilewidth=e.tilewidth,this.tileheight=e.tileheight,this.orientation=e.orientation,this.properties=e.properties,i=this,n=function(e){var t;return t=e.type,t==="tilelayer"?new a(e,i):t==="objectgroup"?new u(e,i):(console.warn("unknown layer type "+t+" requested"),new o(e,i))},this.layers=function(){var t,i,s,o;s=e.layers,o=[];for(t=0,i=s.length;t<i;t++)r=s[t],o.push(n(r));return o}(),h=e.tilesets,l=h.length,s=0,v=function(){++s>=l&&(p&&i.buildLayerCaches(),i.loaded=!0,typeof t=="function"&&t())},this.tilesets=function(){var e,t,n;n=[];for(e=0,t=h.length;e<t;e++)d=h[e],n.push(new f(d,v));return n}(),this.entities.sort(c)},t.prototype.buildLayerCaches=function(){var e,t,n,r;r=this.layers;for(t=0,n=r.length;t<n;t++)e=r[t],e.type==="tilelayer"&&e.buildCache()},t.prototype.drawTile=function(e,t,n,r,i,s,o){var u,a,f,l;l=this.tilesets;for(a=0,f=l.length;a<f;a++){u=l[a];if(u.hasGID(t)){u.drawTile(e,t,n,r,i,s,o);break}}},t.prototype.doCollisions=function(){var e,t,n,r,i,o,u,a;t=this.entities,s.persistentSort(t,c),r=0;for(n=o=1,a=t.length;o<a;n=o+=1){e=this.entities[n];while(r<n&&t[r].x+t[r].shape.bounds_offsets[1]<e.x+e.shape.bounds_offsets[0])++r;for(i=u=r;u<n;i=u+=1)this.doCollision(e,this.entities[i])}},t.prototype.doCollision=function(e,t){var n,r,i,s,o,u,a,f,l,c;if(e["static"]&&t["static"])return;n=e.collides&t.collides,r=e.obstructs&t.obstructs;if(!n&&!r)return;i=e.intersects(t),i&&(u=i[0],a=i[1],s=[u,[-a[0],-a[1]]],typeof e.onCollide=="function"&&e.onCollide(t,i),typeof t.onCollide=="function"&&t.onCollide(e,s),r&&(f=u*a[0],l=u*a[1],e["static"]?(t.x+=f,t.y+=l):t["static"]?(e.x-=f,e.y-=l):(c=.5,o=1-c,e.x-=c*f,e.y-=c*l,t.x+=o*f,t.y+=o*l),typeof e.onObstruct=="function"&&e.onObstruct(t,i),typeof t.onObstruct=="function"&&t.onObstruct(e,s)))},t.prototype.start=function(){var e,t,n,r,i,s,o,u;o=this.layers;for(n=0,i=o.length;n<i;n++)t=o[n],typeof t.onStart=="function"&&t.onStart(t);u=this.entities;for(r=0,s=u.length;r<s;r++)e=u[r],typeof e.onStart=="function"&&e.onStart(e)},t.prototype.update=function(e){var t,n,r,i;i=this.entities;for(n=0,r=i.length;n<r;n++)t=i[n],typeof t.update=="function"&&t.update(e);this.doCollisions()},t.prototype.draw=function(e,t,n){var r,i,s,o;o=this.layers;for(i=0,s=o.length;i<s;i++)r=o[i],r.draw(e,t,n)},t.prototype.debugDraw=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d;r=this.camera,a=t-r.x,f=n-r.y,s=!1;for(o=l=0,p=this.entities.length;l<p;o=l+=1){i=this.entities[o];if(i.boundsIntersects(r))i.shapeSubpath(e,a,f),s=!0;else if(s&&r.boundsLeftOf(i))break}d=this.layers;for(c=0,h=d.length;c<h;c++)u=d[c],u.type==="objectgroup"&&u.debugDraw(e,t,n)},t}(),MapScene:function(){function e(e){this.map=e}return e.prototype.start=function(){var e,t;if(!this.map.loaded)throw""+this.map.name+" not loaded!";t=r.Entity,e=i.Aabb,this.map.camera=new t(0,0,new e([.5*n.width(),.5*n.height()])),this.map.entities.push(this.map.camera),this.map.start()},e.prototype.end=function(){},e.prototype.update=function(e){this.map.update(e)},e.prototype.draw=function(e){var t,r,i,s;r=n.width(),t=n.height(),s=.5*r,i=.5*t,e.clearRect(0,0,r,t),e.beginPath(),this.map.draw(e,s,i),this.map.debugDraw(e,s,i)},e}()}})}.call(this),function(){define("sprite",["jquery","./util"],function(e,t){var n,r;return n="sprites/",r=".json",{Sprite:function(){function i(t,i){var s;this.name=t,this.loaded=!1,s=this,e.getJSON(n+this.name+r,function(e){s.load(e,i)});return}return i.prototype.load=function(e,t){var r,i,s,o,u,a,f,l,c,h,p;u=e.frames,i=e.animations;for(f in i){r=i[f],s=0,p=r.frames;for(c=0,h=p.length;c<h;c++)o=p[c],s+=o[1];i[f].duration=s}this.animations=i,l=this,a=new Image,a.onload=function(){return l.setupFrames(a,u),this.loaded=!0,typeof t=="function"?t():void 0},a.src=n+e.spritesheet},i.prototype.setupFrames=function(e,t){var n,r;r=function(t){var n,r,i,s;return s=t.size[0],i=t.size[1],n=document.createElement("canvas"),n.width=s,n.height=i,r=n.getContext("2d"),r.drawImage(e,t.pos[0],t.pos[1],s,i,0,0,s,i),n},this.frames=function(){var e,i,s;s=[];for(e=0,i=t.length;e<i;e++)n=t[e],s.push(r(n));return s}(),this.frame_offsets=function(){var e,r,i;i=[];for(e=0,r=t.length;e<r;e++)n=t[e],i.push(n.offset);return i}()},i.prototype.startAnimation=function(e){this.current_animation=this.animations[e],this.animation_start_time=t.time()},i.prototype.draw=function(e,n,r,i){var s,o,u,a,f,l,c,h,p,d;o=this.current_animation,u=o.duration,l=-1,s=t.time()-this.animation_start_time,o.loop?s%=u:s>u&&(s=u),d=o.frames;for(h=0,p=d.length;h<p;h++){a=d[h],s-=a[1];if(s<=0){l=a[0];break}}f=this.frames[l],c=this.frame_offsets[l],e.save(),e.translate(n+.5|0,r+.5|0),i&&e.transform(-1,0,0,1,0,0),e.drawImage(f,c[0],c[1]),e.restore()},i}()}})}.call(this),function(){define("loader",["./map","./sprite","./audio"],function(e,t,n){return{LoaderScene:function(){function r(e,t){var n,r,i,s;this.resources=e,this.onload=t,this.loaded={maps:{},sprites:{},sounds:{}},r=0,s=this.resources;for(i in s)n=s[i],r+=Object.keys(n).length;this.resource_count=r;if(r<=0)throw"invalid resource count ("+r+")";return}return r.prototype.start=function(){var r,i,s,o,u,a,f,l,c,h,p,d;r=e.Map,s=t.Sprite,i=n.Sound,a=0,f=this,this.progress=0,this.finished=!1,o=function(){++a,f.progress=a/f.resource_count,a===f.resource_count&&(f.finished=!0,typeof f.onload=="function"&&f.onload(f.loaded))},d=this.resources;for(p in d){l=d[p],h=this.loaded[p];if(p==="maps")for(u in l)c=l[u],h[u]=new r(c.name,c.script,o);else if(p==="sprites")for(u in l)c=l[u],h[u]=new s(c,o);else{if(p!=="sounds")throw"attempting to load unknown type "+p;for(u in l)c=l[u],h[u]=new i(c,o)}}},r.prototype.end=function(){},r.prototype.update=function(e){},r.prototype.draw=function(e){},r}()}})}.call(this),function(){define("physics",["./game"],function(e){return{integrate:function(t,n){var r,i,s,o,u;s=e.invLastDt(),o=t.last_x||t.x,u=t.last_y||t.y,r=t.acceleration||[0,0],i=t.damping||1,t.last_x=t.x,t.last_y=t.y,t.x=t.x+(t.x-o)*n*s*i+r[0]*n*n,t.y=t.y+(t.y-u)*n*s*i+r[1]*n*n,t.last_acceleration=r},getVelocity:function(t,n){var r,i,s,o,u;return s=e.lastDt(),r=e.invLastDt(),o=t.last_x||t.x,u=t.last_y||t.y,i=t.last_acceleration||[0,0],[(t.x-o)*r+.5*i[0]*s,(t.y-u)*r+.5*i[1]*s]},setVelocity:function(t,n,r){var i,s;s=e.lastDt(),i=t.last_acceleration||[0,0],t.last_x=t.x-(n[0]-.5*i[0]*s)*s,t.last_y=t.y-(n[1]-.5*i[1]*s)*s}}})}.call(this),function(){define("test",["./util","./input","./game","./geometry","./entity","./physics"],function(e,t,n,r,i,s){var o,u,a;return a=null,u=null,o=function(e,t){},{setTestSprite:function(e){a=e},setTestSound:function(e){u=e},handlePlayerStart:function(n){var o,f,l,c,h;f=i.Entity,o=r.Aabb,c=r.dotProduct,l=e.constructBitmask,h=new f(n.x,n.y,new o([4,4])),h.obstructs=l([0]),h.collides=l([0]),h.damping=.99,h.last_x=h.x,h.last_y=h.y,h.update=function(e){var n,r,i;n=[0,0],this.grounded?t.jump.pressed?(this.damping=.995,r=100,i=s.getVelocity(this,e),i[1]=-200,s.setVelocity(this,i,e),this.grounded=!1,u.play()):(this.damping=.5,r=2e3):(this.last_y>this.y&&t.jump.released&&(this.last_y=.5*(this.last_y-this.y)+this.y),this.damping=.995,r=100),t.left.state&&(n[0]-=r),t.right.state&&(n[0]+=r),this.grounded&&c(this.ground_normal,n)<0&&(n[1]-=n[0]*this.ground_normal[0]/this.ground_normal[1]);if(!this.grounded||n[0]!==0||Math.abs(this.last_x-this.x)>=1)n[1]+=400,this.grounded=!1;this.acceleration=n,s.integrate(this,e)},h.onObstruct=function(e,t){var n;n=t[1],n[1]>=Math.abs(n[0])&&(this.grounded=!0,this.ground_normal=n)},a.startAnimation("walk"),h.sprite=a,h.draw=function(e,t,n){this.sprite.draw(e,this.x+t,this.y+n,!0)},n.layer.addEntity(h),n.map.camera.update=function(e){this.x=h.x,this.y=h.y}},handleLayerObs:o,handleObs1:function(e,t){o(e,t)},handleZoneCollide:function(e,t){},handleZone1Collide:function(e,t){},handleLayerStart:function(e){}}})}.call(this),function(){requirejs.config({paths:{jquery:"https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min"}}),require(["jquery","game","loader","map","test"],function(e,t,n,r,i){e(function(){var s;e.ajaxSetup({cache:!1}),s=new n.LoaderScene({maps:{test:{name:"test",script:i}},sprites:{test:"test_sprite"},sounds:{test:"sounds/jump.wav"}},function(e){i.setTestSprite(e.sprites.test),i.setTestSound(e.sounds.test),t.switchScene(new r.MapScene(e.maps.test))}),t.init(320,240,1/60,.05,s),t.run()})})}.call(this),define("main",function(){})